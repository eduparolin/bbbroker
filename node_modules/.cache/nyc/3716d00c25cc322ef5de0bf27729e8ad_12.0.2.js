var cov_2mrc3hslx4=function(){var path="/Users/eduardoparolin/Documents/Projetos/Tunts/PGMais/pg013-broker-gsm/modules/sms/Sms.js",hash="769839b717ab42662bb27771dbbcfc3116c730d8",Function=function(){}.constructor,global=new Function('return this')(),gcv="__coverage__",coverageData={path:"/Users/eduardoparolin/Documents/Projetos/Tunts/PGMais/pg013-broker-gsm/modules/sms/Sms.js",statementMap:{"0":{start:{line:1,column:31},end:{line:1,column:79}},"1":{start:{line:3,column:12},end:{line:22,column:1}},"2":{start:{line:24,column:0},end:{line:26,column:2}},"3":{start:{line:25,column:4},end:{line:25,column:32}},"4":{start:{line:28,column:0},end:{line:32,column:2}},"5":{start:{line:29,column:4},end:{line:31,column:7}},"6":{start:{line:34,column:0},end:{line:39,column:2}},"7":{start:{line:35,column:4},end:{line:37,column:7}},"8":{start:{line:38,column:4},end:{line:38,column:41}},"9":{start:{line:41,column:0},end:{line:46,column:2}},"10":{start:{line:42,column:4},end:{line:45,column:7}},"11":{start:{line:48,column:0},end:{line:88,column:2}},"12":{start:{line:49,column:23},end:{line:67,column:10}},"13":{start:{line:69,column:4},end:{line:87,column:5}},"14":{start:{line:70,column:8},end:{line:84,column:10}},"15":{start:{line:86,column:8},end:{line:86,column:44}},"16":{start:{line:90,column:0},end:{line:98,column:2}},"17":{start:{line:91,column:4},end:{line:97,column:6}},"18":{start:{line:100,column:0},end:{line:100,column:21}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:24,column:16},end:{line:24,column:17}},loc:{start:{line:24,column:33},end:{line:26,column:1}},line:24},"1":{name:"(anonymous_1)",decl:{start:{line:28,column:39},end:{line:28,column:40}},loc:{start:{line:28,column:51},end:{line:32,column:1}},line:28},"2":{name:"(anonymous_2)",decl:{start:{line:34,column:36},end:{line:34,column:37}},loc:{start:{line:34,column:60},end:{line:39,column:1}},line:34},"3":{name:"(anonymous_3)",decl:{start:{line:41,column:26},end:{line:41,column:27}},loc:{start:{line:41,column:38},end:{line:46,column:1}},line:41},"4":{name:"(anonymous_4)",decl:{start:{line:48,column:22},end:{line:48,column:23}},loc:{start:{line:48,column:90},end:{line:88,column:1}},line:48},"5":{name:"(anonymous_5)",decl:{start:{line:90,column:29},end:{line:90,column:30}},loc:{start:{line:90,column:41},end:{line:98,column:1}},line:90}},branchMap:{"0":{loc:{start:{line:69,column:4},end:{line:87,column:5}},type:"if",locations:[{start:{line:69,column:4},end:{line:87,column:5}},{start:{line:69,column:4},end:{line:87,column:5}}],line:69}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0},b:{"0":[0,0]},_coverageSchema:"d34fc3e6b8297bcde183f5492bcb8fcb36775295"},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();const[Sequelize,sequelize]=(cov_2mrc3hslx4.s[0]++,require('../common/services/database.service')());const Sms=(cov_2mrc3hslx4.s[1]++,sequelize.define('sms',{id:{type:Sequelize.UUID,primaryKey:true,defaultValue:Sequelize.UUIDV4},route_id:{type:Sequelize.UUID,defaultValue:Sequelize.UUIDV4,allowNull:false},channel_id:{type:Sequelize.UUID,defaultValue:Sequelize.UUIDV4},chip_id:{type:Sequelize.UUID,defaultValue:Sequelize.UUIDV4,allowNull:false},direction:{type:Sequelize.ENUM('INBOUND','OUTBOUND'),allowNull:false},origin:{type:Sequelize.STRING(45),allowNull:false},destination:{type:Sequelize.STRING(45),allowNull:false},message:{type:Sequelize.STRING(255),allowNull:false},sent_at:{type:Sequelize.DATE,allowNull:false},delivered_at:{type:Sequelize.DATE},status:{type:Sequelize.STRING(45),default:'SENT'},webhook_attempts:{type:Sequelize.INTEGER,default:0},webhook_result:{type:Sequelize.STRING(45),default:'PENDING'}},{tableName:'sms'}));cov_2mrc3hslx4.s[2]++;Sms.createSms=function(smsInfo){cov_2mrc3hslx4.f[0]++;cov_2mrc3hslx4.s[3]++;return this.create(smsInfo);};cov_2mrc3hslx4.s[4]++;Sms.prototype.increaseWebhookAttempt=function(){cov_2mrc3hslx4.f[1]++;cov_2mrc3hslx4.s[5]++;return this.update({webhook_attempts:Sequelize.literal('webhook_attempts + 1')});};cov_2mrc3hslx4.s[6]++;Sms.prototype.updateWebhookResult=async function(result){cov_2mrc3hslx4.f[2]++;cov_2mrc3hslx4.s[7]++;await this.update({webhook_result:result});cov_2mrc3hslx4.s[8]++;return this.increaseWebhookAttempt();};cov_2mrc3hslx4.s[9]++;Sms.prototype.delivered=function(){cov_2mrc3hslx4.f[3]++;cov_2mrc3hslx4.s[10]++;return this.update({delivered_at:Sequelize.fn('NOW'),status:'DELIVERED'});};cov_2mrc3hslx4.s[11]++;Sms.updateSmsByDate=async function(deliveredAt,sent_at_max,sent_at_min,destination){cov_2mrc3hslx4.f[4]++;let affectedRows=(cov_2mrc3hslx4.s[12]++,await sequelize.query('UPDATE sms\n'+'    SET delivered_at = :deliveredAt, status = :status\n'+'        WHERE destination = :destination\n'+'            AND sent_at <= :sent_at_max\n'+'                AND sent_at >= :sent_at_min\n'+'                    AND delivered_at IS NULL\n'+'    ORDER BY sent_at DESC\n'+'    LIMIT 1',{replacements:{deliveredAt:deliveredAt,status:'DELIVERED',destination:destination,sent_at_max:sent_at_max,sent_at_min:sent_at_min},type:sequelize.QueryTypes.UPDATE}));cov_2mrc3hslx4.s[13]++;if(affectedRows>0){cov_2mrc3hslx4.b[0][0]++;cov_2mrc3hslx4.s[14]++;return await this.findOne({where:{destination:destination,[Sequelize.Op.and]:[{sent_at:{[Sequelize.Op.lte]:sent_at_max}},{sent_at:{[Sequelize.Op.gte]:sent_at_min}}],delivered_at:{[Sequelize.Op.ne]:deliveredAt}},order:[['sent_at','DESC']]});}else{cov_2mrc3hslx4.b[0][1]++;cov_2mrc3hslx4.s[15]++;throw new Error('no affected rows');}};cov_2mrc3hslx4.s[16]++;Sms.getSmsByPendingWebhook=function(){cov_2mrc3hslx4.f[5]++;cov_2mrc3hslx4.s[17]++;return this.findAll({where:{[Sequelize.Op.or]:[{status:'RECEIVED'},{status:'DELIVERED'}],webhook_result:{[Sequelize.Op.notLike]:'SENT'}}});};cov_2mrc3hslx4.s[18]++;module.exports=Sms;